image: node:18  # Use appropriate image for your stack

pipelines:
  branches:
    develop:
      - step:
          name: Deploy to Staging
          caches:
            - node
            - nvmcache
          script:
            - echo "Deploying to Staging..."
            - mkdir -p ~/.ssh
            - echo "$SSH_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - echo "DB_HOST=$DB_HOST" >> .env
            - echo "DB_USER=$DB_USER" >> .env
            - echo "DB_PASSWORD=$DB_PASSWORD" >> .env
            - echo "DB_NAME=$DB_NAME" >> .env
            - echo "DB_PORT=$DB_PORT" >> .env
            - scp -o StrictHostKeyChecking=no .env $SSH_USER@$UAT_HOST:$UAT_PATH/.env
            # - ssh -o StrictHostKeyChecking=no $SSH_USER@$UAT_HOST "source ~/.nvm/nvm.sh && nvm list && nvm use 20 && npm -v && cd $UAT_PATH && git pull origin develop && npm install && npm install -g pm2 serve && && pm2 restart all"
            - ssh -T -o StrictHostKeyChecking=no $SSH_USER@$UAT_HOST
            - export NVM_DIR="$HOME/.nvm"
            - mkdir -p $NVM_DIR
            - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.2/install.sh | bash
            - source "$NVM_DIR/nvm.sh"
            - nvm install 23
            - nvm use 23
            - npm install -g pm2 serve
            - cd $UAT_PATH && git pull origin develop
            - npm install
            - npm run build
            - pm2 start "serve" --name mhf-cicd-uat -- -s dist -l 3000
              
            #   nvm use node && 
            #   npm -v &&
            #   cd $UAT_PATH &&
            #   git pull origin develop &&
            #   npm install &&
            #   node app.js &&
            #   echo Success "
              
  # && npm install && pm2 restart all

    main:
      - step:
          name: Deploy to Production
          script:
            - echo "Deploying to Production..."
            - mkdir -p ~/.ssh
            - echo "$SSH_KEY" > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh -o StrictHostKeyChecking=no $SSH_USER@$PROD_HOST "cd $PROD_PATH && git pull origin main && npm install && pm2 restart all"

definitions:
  caches:
    nvmcache: $HOME/.nvm